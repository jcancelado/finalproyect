{% extends 'base.html' %}
{% block content %}
  <div style="padding: 2rem; max-width: 600px; margin: 0 auto;">
    <h1>‚ûï Crear Nuevo Producto</h1>
    <p style="color: #666;">Tienda: <strong>{{ local_id }}</strong></p>
    
    {% if error %}
      <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <div class="card">
      <form method="post" enctype="multipart/form-data">
        <label for="nombre">
          Nombre del producto
          <input type="text" id="nombre" name="nombre" required placeholder="Ej: Arroz integral" style="width: 100%;">
        </label>
        
        <label for="precio">
          Precio ($)
          <input type="number" id="precio" name="precio" step="0.01" required placeholder="Ej: 8200" style="width: 100%;">
        </label>
        
        <label for="stock">
          Stock (cantidad)
          <input type="number" id="stock" name="stock" required placeholder="Ej: 50" style="width: 100%;">
        </label>
        
        <label for="proveedor">
          Proveedor (opcional)
          <select id="proveedor" name="proveedor" style="width: 100%;">
            <option value="">-- Sin proveedor --</option>
            {% if proveedores and proveedores|length > 0 %}
              {% for prov_id, prov in proveedores.items() %}
                <option value="{{ prov_id }}">{{ prov.nombre }}{% if prov.contacto %} ({{ prov.contacto }}){% endif %}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled id="loading">Cargando proveedores...</option>
            {% endif %}
          </select>
          <small style="color: #999; display: block; margin-top: 0.5rem;">
            Selecciona de tu lista o <a href="{{ url_for('tendero_crear_proveedor') }}" target="_blank">crea uno nuevo</a>
          </small>
        </label>
        
        <label for="imagen">
          üì∏ Imagen del producto (PNG, JPG, GIF, WebP; m√°x 5MB)
          <input type="file" id="imagen" name="imagen" accept=".png,.jpg,.jpeg,.gif,.webp" style="width: 100%; padding: 0.5rem; border: 2px dashed var(--border); border-radius: 5px; cursor: pointer;">
          <small style="color: #999; display: block; margin-top: 0.5rem;">Opcional pero recomendado para mejorar presentaci√≥n</small>
        </label>
        
        <button type="submit" style="width: 100%; margin-top: 1rem; padding: 0.75rem;">‚úÖ Crear Producto</button>
      </form>
    </div>
    
    <div style="text-align: center; margin-top: 1rem;">
      <a href="{{ url_for('tendero_inventario', local_id=local_id) }}" style="color: var(--accent); text-decoration: none;">‚Üê Volver al inventario</a>
    </div>
  </div>

  <script>
    // Cargar lista de proveedores
    document.addEventListener('DOMContentLoaded', function() {
      const select = document.getElementById('proveedor');
      // If server-side already populated providers, skip client fetch
      if (select && select.options && select.options.length > 1) {
        const loading = document.getElementById('loading');
        if (loading) loading.remove();
        return;
      }

      fetch('{{ url_for("api_get_proveedores") }}', { credentials: 'same-origin' })
        .then(response => {
          if (!response.ok) throw new Error('Error al cargar proveedores: ' + response.status);
          return response.json();
        })
        .then(data => {
          const select = document.getElementById('proveedor');
          const loading = document.getElementById('loading');
          
          // Limpiar opciones de carga
          if (loading) loading.remove();
          
          // Si hay proveedores, agregarlos
          if (data.proveedores && Object.keys(data.proveedores).length > 0) {
            Object.entries(data.proveedores).forEach(([id, proveedor]) => {
              const option = document.createElement('option');
              option.value = id;
              option.textContent = proveedor.nombre || 'Sin nombre';
              if (proveedor.contacto) {
                option.textContent += ` (${proveedor.contacto})`;
              }
              select.appendChild(option);
            });
          } else {
            // No providers returned
            const noOpt = document.createElement('option');
            noOpt.value = '';
            noOpt.disabled = true;
            noOpt.textContent = '-- No hay proveedores --';
            select.appendChild(noOpt);
          }
        })
        .catch(error => {
          console.error('Error al cargar proveedores:', error);
          const select = document.getElementById('proveedor');
          // show error option
          select.innerHTML = '';
          const errOpt = document.createElement('option');
          errOpt.value = '';
          errOpt.disabled = true;
          errOpt.textContent = '-- Error al cargar proveedores --';
          select.appendChild(errOpt);
        });
    });
  </script>
{% endblock %}

